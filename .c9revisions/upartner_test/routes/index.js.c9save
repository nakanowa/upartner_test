{"ts":1355443676706,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"/*\n * トップページ表示\n */\nexports.index = function(req, res){\n    //res.charset = 'ISO-8859-1';\n    \n        console.log(req.session.loginflg);\n        console.log(req.session.user);\n        /** ログイン状態チェック **/\n\n        if(req.session.loginflg === '1'){\n            res.render('index', { user : req.session.user,\n                        title: 'U-PARTNER' ,\n                        about: 'このサイトはEXPRESSで作られています。',\n                        textarea2:''});\n                        return;\n        }else{\n            res.render('top', { user : req.session.user,\n                        title: 'U-PARTNER' ,\n                        about: 'このサイトはEXPRESSで作られています。',\n                        textarea2:''});\n            }\n};\n\n\n/*\n * トークエリア\n */\nexports.talk = function(req,res){\n    var TextArea = req.body.textarea + req.body.talkarea + '\\n';\n\n        res.render('index', {\n            user : req.session.user,\n            title: 'U-PARTNER' ,\n            about : 'Aさんが発言しました。',\n            textarea2:TextArea\n        });\n        return;\n};\n\n\n/*\n * ログイン\n */\n exports.getLogin = function(req,res){\n     res.redirect('/');\n }\n \n \nexports.login = function(req ,res){\n\n\n    var errmsg;\n\n    // users model 読み込み\n    var users = require('../models/users');    \n    \n    // 入力「ユーザ」「パスワード」取得\n    var userid = req.body.user;\n    var passwd = req.body.pass;\n    \n    // ユーザ入力チェック\n    if (userid === null || userid === '' ){\n        errmsg = \"ユーザ・パスワードを入力してください。\";\n        res.render('index', {user : req.session.user,title: 'U-PARTNER' ,about : errmsg,textarea2:''});\n        return;\n    }\n    // パスワード入力チェック\n    if(passwd === null || passwd === '' ){\n        errmsg = \"ユーザ・パスワードを入力してください。\";\n        res.render('index', {user : req.session.user,title: 'U-PARTNER' ,about : errmsg,textarea2:''});\n        return;\n    }\n\n    // データの取得\n    users.findOne({userid:userid}, function(err , users){\n        \n        // ユーザ情報取得チェック\n        if(users === null){\n            errmsg = \"ユーザが存在しません userid：\" + userid;\n            res.render('index', {user : req.session.user,title: 'U-PARTNER' ,about : errmsg,textarea2:''});\n            return;\n        }\n        \n        // パスワードチェック\n        if(users.password === passwd){\n            \n            //セッションに格納する\n            req.session.loginflg = '1';\n            req.session.name = users.name;\n            req.session.user = users.userid;\n            req.session.pass = users.password;\n            req.session.email = users.email;\n\n            errmsg = \"ログインに成功しました\";\n            res.render('index', {user : req.session.user,title: 'U-PARTNER' ,about : errmsg,textarea2:''});\n            \n        }else{\n            errmsg = \"ログインに失敗しました\";\n           res.render('index', {user : req.session.user,title: 'U-PARTNER' ,about : errmsg,textarea2:''});\n\n        }\n \n    });\n\n};\n\n\n/*\n * ログアウト\n */\n exports.getLogout = function(req,res){\n     res.redirect('/');\n }\n\n\nexports.logout = function(req,res){\n    req.session.destroy();\n    res.redirect('/');\n}\n\n\n"]],"start1":0,"start2":0,"length1":0,"length2":2961}]],"length":2961}
